name: ðŸ”’ Security Scan

on:
  push:
    branches: [ main ]
    paths:
      - '**.tf'
      - '**.json'
      - '.github/workflows/security.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**.tf'
      - '**.json'
      - '.github/workflows/security.yml'
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  trivy:
    name: Trivy - Infrastructure Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          exit-code: '1'
          severity: 'HIGH,CRITICAL'

      - name: Comment PR on Security Issues
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ” **Security Issues Detected**\n\nCheck the job logs for details. High/Critical severity issues must be resolved.'
            })

  checkov:
    name: Checkov - Policy as Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: terraform
          quiet: false
          soft_fail: false
          skip_check: 'CKV_TERRAFORM_1,CKV_AWS_108'  # Adjust as needed
        continue-on-error: true

      - name: Comment PR with Checkov Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const status = '${{ steps.checkov.outcome }}' === 'success';
            const message = status 
              ? 'âœ… **Checkov Policy Check Passed**'
              : 'âš ï¸ **Checkov Policy Violations Found**\n\nSee job logs for details.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

  semgrep:
    name: Semgrep - Code Pattern Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          generateSarif: 'true'
          config: >-
            p/security-audit
            p/terraform

      - name: Upload SARIF Report
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'semgrep.sarif'
        if: always()

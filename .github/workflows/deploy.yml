name: üöÄ Deploy Infrastructure

on:
  push:
    branches: [ main ]
    paths:
      - '**.tf'
      - '.github/workflows/deploy.yml'

permissions:
  contents: read
  deployments: write
  pull-requests: read

jobs:
  pre-deploy-checks:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Format Check
        run: terraform fmt -check -recursive .

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: Check AWS Credentials
        run: |
          if [ -z "$AWS_ACCESS_KEY_ID" ]; then
            echo "‚ùå AWS_ACCESS_KEY_ID not configured"
            echo "‚ÑπÔ∏è  Set AWS credentials in repo secrets for deployment"
            exit 1
          fi
          echo "‚úÖ AWS credentials available"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        continue-on-error: true

      - name: Check for terraform.tfvars
        run: |
          echo "üìã Checking deployment configuration..."
          if [ ! -f terraform.tfvars ]; then
            echo "‚ö†Ô∏è  WARNING: terraform.tfvars not found"
            echo ""
            echo "To complete deployment, you MUST commit terraform.tfvars with:"
            echo "  ‚Ä¢ ami_id"
            echo "  ‚Ä¢ kms_key_arn"
            echo "  ‚Ä¢ subnet_ids"
            echo "  ‚Ä¢ security_group_id"
            echo ""
            echo "See terraform.tfvars.example for template"
            echo "‚è≠Ô∏è  Continuing with validation..."
          else
            echo "‚úÖ terraform.tfvars found"
          fi

  plan:
    name: Generate Production Plan
    runs-on: ubuntu-latest
    needs: [ pre-deploy-checks ]
    if: success()
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
        continue-on-error: true

      - name: Check for terraform.tfvars
        run: |
          if [ ! -f terraform.tfvars ]; then
            echo "‚ùå ERROR: terraform.tfvars file not found"
            echo ""
            echo "To deploy, you must create terraform.tfvars with required variables:"
            echo "  ami_id = \"ami-xxxxx\""
            echo "  kms_key_arn = \"arn:aws:kms:...\""
            echo "  subnet_ids = [\"subnet-xxx\", \"subnet-yyy\"]"
            echo "  security_group_id = \"sg-xxxxx\""
            echo ""
            echo "See terraform.tfvars.example for reference"
            exit 1
          fi
          echo "‚úÖ terraform.tfvars found and will be used"

      - name: Terraform Init
        run: terraform init
        continue-on-error: true

      - name: Generate Plan
        run: terraform plan -input=false -out=/tmp/tfplan
        continue-on-error: true

      - name: Store Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: /tmp/tfplan
        if: always()

  approval:
    name: Requires Manual Approval
    runs-on: ubuntu-latest
    needs: [ plan ]
    if: success()
    
    steps:
      - name: Create Deployment Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üöÄ Deployment Approval - ${context.sha.substring(0, 8)}`,
              body: `### Deployment Approval Required\n\n**Commit:** \`${context.sha.substring(0, 8)}\`\n**Branch:** \`${context.ref.replace('refs/heads/', '')}\`\n\nComment \`/approve\` to proceed or \`/reject\` to cancel deployment.\n\n**‚ö†Ô∏è WARNING:** This will modify production infrastructure. Ensure plan has been reviewed.`,
              labels: ['deployment']
            });
            
            console.log('Created approval issue:', issue.data.number);

  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: [ approval ]
    if: contains(github.event.head_commit.message, '[deploy]') || contains(github.event.ref, 'deploy-')
    
    environment:
      name: production
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
        continue-on-error: true

      - name: Terraform Init
        run: terraform init
        continue-on-error: true

      - name: Download Saved Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: /tmp/

      - name: Verify Plan Artifact
        run: |
          if [ ! -f /tmp/tfplan ]; then
            echo "‚ùå ERROR: Saved terraform plan not found"
            echo ""
            echo "This usually means:"
            echo "  1. The plan job failed or was skipped"
            echo "  2. The artifact expired (default: 5 days)"
            echo "  3. The plan was not properly saved"
            exit 1
          fi
          echo "‚úÖ Plan artifact found"

      - name: Apply Terraform Plan
        run: terraform apply -input=false -no-color /tmp/tfplan
        continue-on-error: true

      - name: Save Terraform State
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: .terraform/**
        if: always()

      - name: Deployment Success Notification
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **Deployment Successful**\n\nInfrastructure has been deployed to AWS.'
            })

      - name: Deployment Failure Notification
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Deployment Failed**\n\nCheck logs for details and investigate before retrying.'
            })

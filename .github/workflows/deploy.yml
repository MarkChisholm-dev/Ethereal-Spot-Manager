name: ğŸš€ Deploy Infrastructure

on:
  push:
    branches: [ main ]
    paths:
      - '**.tf'
      - '.github/workflows/deploy.yml'

permissions:
  contents: read
  deployments: write
  pull-requests: read

jobs:
  pre-deploy-checks:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Format Check
        run: terraform fmt -check -recursive .

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: Check AWS Credentials
        run: |
          if [ -z "$AWS_ACCESS_KEY_ID" ]; then
            echo "âŒ AWS_ACCESS_KEY_ID not configured"
            echo "â„¹ï¸  Required GitHub secrets: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY"
            exit 1
          fi
          echo "âœ… AWS credentials available"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        continue-on-error: true

  plan:
    name: Generate Production Plan
    runs-on: ubuntu-latest
    needs: [ pre-deploy-checks ]
    if: success()
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
        continue-on-error: true

      - name: Generate terraform.tfvars from Secrets
        run: |
          cat > terraform.tfvars << 'EOF'
          # Variables generated from GitHub Secrets
          ami_id            = "${{ secrets.TF_VAR_AMI_ID }}"
          kms_key_arn       = "${{ secrets.TF_VAR_KMS_KEY_ARN }}"
          subnet_ids        = ${{ secrets.TF_VAR_SUBNET_IDS }}
          security_group_id = "${{ secrets.TF_VAR_SECURITY_GROUP_ID }}"
          
          # Optional: Override defaults if needed
          # instance_type           = "${{ secrets.TF_VAR_INSTANCE_TYPE || 'g4dn.xlarge' }}"
          # desired_capacity        = ${{ secrets.TF_VAR_DESIRED_CAPACITY || '10' }}
          # environment             = "${{ secrets.TF_VAR_ENVIRONMENT || 'production' }}"
          EOF
          
          echo "âœ… terraform.tfvars generated from GitHub Secrets"
          echo "ğŸ“‹ Deployed configuration:"
          echo "  - AMI ID: ${{ secrets.TF_VAR_AMI_ID }}"
          echo "  - KMS Key: ${{ secrets.TF_VAR_KMS_KEY_ARN }}"
          echo "  - Subnets: ${{ secrets.TF_VAR_SUBNET_IDS }}"
          echo "  - Security Group: ${{ secrets.TF_VAR_SECURITY_GROUP_ID }}"

      - name: Terraform Init
        run: terraform init
        continue-on-error: true

      - name: Generate Plan
        run: terraform plan -input=false -out=/tmp/tfplan
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        continue-on-error: true

      - name: Store Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: /tmp/tfplan
        if: always()

  approval:
    name: Requires Manual Approval
    runs-on: ubuntu-latest
    needs: [ plan ]
    if: success()
    
    steps:
      - name: Create Deployment Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš€ Deployment Approval - ${context.sha.substring(0, 8)}`,
              body: `### Deployment Approval Required\n\n**Commit:** \`${context.sha.substring(0, 8)}\`\n**Branch:** \`${context.ref.replace('refs/heads/', '')}\`\n\nComment \`/approve\` to proceed or \`/reject\` to cancel deployment.\n\n**âš ï¸ WARNING:** This will modify production infrastructure. Ensure plan has been reviewed.`,
              labels: ['deployment']
            });
            
            console.log('Created approval issue:', issue.data.number);

  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: [ approval ]
    if: contains(github.event.head_commit.message, '[deploy]') || contains(github.event.ref, 'deploy-')
    
    environment:
      name: production
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
        continue-on-error: true

      - name: Generate terraform.tfvars from Secrets
        run: |
          cat > terraform.tfvars << 'EOF'
          # Variables generated from GitHub Secrets for deployment
          ami_id            = "${{ secrets.TF_VAR_AMI_ID }}"
          kms_key_arn       = "${{ secrets.TF_VAR_KMS_KEY_ARN }}"
          subnet_ids        = ${{ secrets.TF_VAR_SUBNET_IDS }}
          security_group_id = "${{ secrets.TF_VAR_SECURITY_GROUP_ID }}"
          EOF
          
          echo "âœ… terraform.tfvars generated for apply"

      - name: Terraform Init
        run: terraform init
        continue-on-error: true

      - name: Download Saved Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: /tmp/

      - name: Verify Plan Artifact
        run: |
          if [ ! -f /tmp/tfplan ]; then
            echo "âŒ ERROR: Saved terraform plan not found"
            echo ""
            echo "This usually means:"
            echo "  1. The plan job failed or was skipped"
            echo "  2. The artifact expired (default: 5 days)"
            echo "  3. The plan was not properly saved"
            exit 1
          fi
          echo "âœ… Plan artifact found"

      - name: Apply Terraform Plan
        run: terraform apply -input=false -no-color /tmp/tfplan
        continue-on-error: true

      - name: Save Terraform State
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: .terraform/**
        if: always()

      - name: Deployment Success Notification
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Deployment Successful**\n\nInfrastructure has been deployed to AWS.'
            })

      - name: Deployment Failure Notification
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Deployment Failed**\n\nCheck logs for details and investigate before retrying.'
            })
